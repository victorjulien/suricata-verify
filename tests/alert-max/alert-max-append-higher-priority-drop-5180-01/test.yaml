args:
- -k none
- --runmode=single
- --set stream.midstream=true
- --simulate-ips

pcap: ../alert-max-append-higher-priority/input.pcap

checks:
# Sub-test 1
- filter:
    lt-version: 8.0.4
    gt-version: 8.0.4
    count: 1
    match:
      event_type: alert
      pcap_cnt: 1
      pkt_src: "wire/pcap"
      alert.signature_id: 1
      verdict.action: drop
# Sub-test 2
- filter:
    lt-version: 8.0.4
    gt-version: 8.0.4
    count: 1
    match:
      event_type: alert
      pcap_cnt: 1
      pkt_src: "wire/pcap"
      alert.signature_id: 2
      verdict.action: drop
# Sub-test 3
- filter:
    # suricata 7 doesn't show this alert.
    # if we don't drop the flow, it matches against the stream
    # (pkt_srt: stream (flow timeout))
    min-version: 9
    count: 1
    match:
      event_type: alert
      pcap_cnt: 1
      pkt_src: "wire/pcap"
      alert.signature_id: 3
      verdict.action: drop
# Sub-test 4
- filter:
    # suricata 8 doesn't show this alert
    lt-version: 8.0
    count: 1
    match:
      event_type: alert
      alert.signature_id: 4
# Sub-test 5
- filter:
    # suricata 7 doesn't show this alert.
    # if we don't drop the flow, it matches against the stream
    # (pkt_srt: stream (flow timeout))
    lt-version: 8.0
    count: 0
    match:
      event_type: alert
      pcap_cnt: 1
      pkt_src: "wire/pcap"
      alert.signature_id: 3
      verdict.action: drop
# Sub-test 6
- filter:
    min-version: 9
    count: 0
    match:
      event_type: alert
      alert.signature_id: 4
# Sub-test 7
- filter:
    count: 0
    match:
      event_type: alert
      alert.signature_id: 5
# Sub-test 8
- filter:
    lt-version: 8.0.4
    gt-version: 8.0.4
    count: 1
    match:
      event_type: drop
      pkt_src: "wire/pcap"
      pcap_cnt: 1
      drop.reason: rules
# Sub-test 9
- filter:
    count: 1
    match:
      event_type: flow
      flow.action: drop
# Sub-test 10
- filter:
    # as suricata 7 won't have a match for sid 3,
    # the overflow check fails for 7
    min-version: 9
    count: 1
    match:
      event_type: stats
      stats.detect.alert_queue_overflow: 2
      stats.detect.alert: 3
      stats.decoder.pkts: 1
      stats.ips.blocked: 1
      stats.ips.accepted: 0
      stats.ips.drop_reason.rules: 1
# Sub-test 11
- filter:
    lt-version: 8.0
    count: 1
    match:
      event_type: stats
      stats.detect.alert_queue_overflow: 1
      stats.detect.alert: 3
      stats.decoder.pkts: 1
      stats.ips.blocked: 1
      stats.ips.accepted: 0
      stats.ips.drop_reason.rules: 1
